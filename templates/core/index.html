{% extends 'base.html' %}

{% block title %}Записи денежного потока - ДДС Менеджер{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Заголовок страницы с кнопками действий -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-table"></i> Записи денежного потока</h1>
                <p class="text-muted mb-0">Управляйте денежными потоками с расширяемыми справочными списками</p>
            </div>
            <div class="btn-group">
                <!-- Кнопка добавления новой записи -->
                <a href="{% url 'core:record_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Добавить запись
                </a>
                <!-- Кнопка управления справочниками -->
                <a href="{% url 'core:directory_management' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-gear"></i> Управление списками
                </a>
            </div>
        </div>

        <!-- Аналитическая панель -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Всего записей</h6>
                                <h3 class="mb-0">{{ total_records }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-list-ul fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Доходы</h6>
                                <h3 class="mb-0">{{ total_income|floatformat:2 }} ₽</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-arrow-up-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Расходы</h6>
                                <h3 class="mb-0">{{ total_expenses|floatformat:2 }} ₽</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-arrow-down-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card {% if balance >= 0 %}bg-info{% else %}bg-warning{% endif %} text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Баланс</h6>
                                <h3 class="mb-0">{{ balance|floatformat:2 }} ₽</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-calculator fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Панель фильтрации записей -->
        <div class="card filter-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Фильтры</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <!-- Фильтр по дате начала -->
                    <div class="col-md-2">
                        <label for="{{ filter_form.date_from.id_for_label }}" class="form-label">Дата с</label>
                        {{ filter_form.date_from }}
                        {% if filter_form.date_from.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in filter_form.date_from.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <!-- Фильтр по дате окончания -->
                    <div class="col-md-2">
                        <label for="{{ filter_form.date_to.id_for_label }}" class="form-label">Дата по</label>
                        {{ filter_form.date_to }}
                        {% if filter_form.date_to.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in filter_form.date_to.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <!-- Фильтр по статусу -->
                    <div class="col-md-2">
                        <label for="{{ filter_form.status.id_for_label }}" class="form-label">Статус</label>
                        {{ filter_form.status }}
                    </div>
                    <!-- Фильтр по типу операции -->
                    <div class="col-md-2">
                        <label for="{{ filter_form.type.id_for_label }}" class="form-label">Тип</label>
                        {{ filter_form.type }}
                    </div>
                    <!-- Фильтр по категории -->
                    <div class="col-md-2">
                        <label for="{{ filter_form.category.id_for_label }}" class="form-label">Категория</label>
                        {{ filter_form.category }}
                    </div>
                    <!-- Фильтр по подкатегории -->
                    <div class="col-md-2">
                        <label for="{{ filter_form.subcategory.id_for_label }}" class="form-label">Подкатегория</label>
                        {{ filter_form.subcategory }}
                    </div>
                    <!-- Кнопки управления фильтрами -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-search"></i> Применить фильтры
                        </button>
                        <a href="{% url 'core:index' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Очистить фильтры
                        </a>
                    </div>
                    
                    <!-- Отображение общих ошибок валидации формы -->
                    {% if filter_form.non_field_errors %}
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                                {% for error in filter_form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Таблица записей денежного потока -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Записи 
                    <span class="badge bg-secondary">{{ total_records }}</span>
                </h5>
                <div>
                    <small class="text-muted">
                        Показано {{ page_obj.start_index }}-{{ page_obj.end_index }} из {{ page_obj.paginator.count }}
                    </small>
                </div>
            </div>
            <div class="card-body p-0">
                {% if page_obj %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <!-- Заголовки таблицы -->
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>Статус</th>
                                    <th>Тип</th>
                                    <th>Категория</th>
                                    <th>Подкатегория</th>
                                    <th class="text-end">Сумма</th>
                                    <th>Комментарий</th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Цикл по записям -->
                                {% for record in page_obj %}
                                <tr>
                                    <!-- Дата операции -->
                                    <td>
                                        <span class="badge bg-info">{{ record.date|date:"d.m.Y" }}</span>
                                    </td>
                                    <!-- Статус операции -->
                                    <td>
                                        <span class="badge bg-secondary">{{ record.status.name }}</span>
                                    </td>
                                    <!-- Тип операции с цветовым кодированием -->
                                    <td>
                                        <span class="badge {% if 'Пополнение' in record.type.name or 'Replenishment' in record.type.name %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ record.type.name }}
                                        </span>
                                    </td>
                                    <!-- Категория и подкатегория -->
                                    <td>{{ record.category.name }}</td>
                                    <td>{{ record.subcategory.name }}</td>
                                    <!-- Сумма с цветовым кодированием -->
                                    <td class="text-end">
                                        <span class="{% if 'Пополнение' in record.type.name or 'Replenishment' in record.type.name %}amount-positive{% else %}amount-negative{% endif %}">
                                            {{ record.amount|floatformat:2 }} ₽
                                        </span>
                                    </td>
                                    <!-- Комментарий (обрезанный) -->
                                    <td>
                                        {% if record.comment %}
                                            <span title="{{ record.comment }}">
                                                {{ record.comment|truncatechars:30 }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <!-- Кнопки действий -->
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Кнопка редактирования -->
                                            <a href="{% url 'core:record_edit' record.pk %}" 
                                               class="btn btn-outline-primary btn-sm" 
                                               title="Редактировать">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <!-- Кнопка удаления с подтверждением -->
                                            <a href="{% url 'core:record_delete' record.pk %}" 
                                               class="btn btn-outline-danger btn-sm" 
                                               title="Удалить"
                                               onclick="return confirm('Вы уверены, что хотите удалить эту запись?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">Записи не найдены</h4>
                        <p class="text-muted">Начните с создания первой записи денежного потока.</p>
                        <a href="{% url 'core:record_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Создать первую запись
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Records pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page=1">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Валидация диапазона дат в реальном времени
    $('#id_date_from, #id_date_to').on('change', function() {
        var dateFrom = $('#id_date_from').val();
        var dateTo = $('#id_date_to').val();
        
        if (dateFrom && dateTo) {
            var fromDate = new Date(dateFrom);
            var toDate = new Date(dateTo);
            
            if (fromDate > toDate) {
                // Подсвечиваем поля красным
                $('#id_date_from, #id_date_to').addClass('is-invalid');
                
                // Показываем предупреждение
                if (!$('.date-validation-warning').length) {
                    $('<div class="date-validation-warning alert alert-warning mt-2">' +
                      '<i class="bi bi-exclamation-triangle"></i> ' +
                      'Дата "с" не может быть больше даты "по". Пожалуйста, выберите корректный диапазон.' +
                      '</div>').insertAfter('#id_date_to');
                }
            } else {
                // Убираем подсветку ошибок
                $('#id_date_from, #id_date_to').removeClass('is-invalid');
                $('.date-validation-warning').remove();
            }
        } else {
            // Убираем подсветку если одно из полей пустое
            $('#id_date_from, #id_date_to').removeClass('is-invalid');
            $('.date-validation-warning').remove();
        }
    });
});
</script>
{% endblock %}
